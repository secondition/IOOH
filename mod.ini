; EFMI Key Context Manager v4.0 - GUI版
; 按键上下文切换系统 - 基于图像GUI的选择器显示
; 
; 改进：使用3DMigoto的2D绘制功能显示图像GUI，替代无法实现的文本显示
; 参考：Snaccubus的EndminF MegaMenu Mod实现
; 
; 作者: EFMI Community
; 配套工具: key_context_configurator.py, generate_ui_textures.py

; ==================== 核心变量定义 ====================
[Constants]
global persist $selected_character = 0
global persist $show_character_ui = 1  ; UI显示开关（0=隐藏, 1=显示）
global persist $max_characters = 3     ; 总角色数（由配置脚本自动设置）

; UI位置和大小设置（可根据需要调整）
global persist $ui_width = 0.25        ; UI宽度（屏幕比例）
global persist $ui_height = 0.08       ; UI高度（屏幕比例）
global persist $ui_pos_x = 0.37        ; UI X位置（0-1，左到右）
global persist $ui_pos_y = 0.05        ; UI Y位置（0-1，上到下）

; 帮助文本位置
global persist $help_pos_x = 0.01
global persist $help_pos_y = 0.90
global persist $help_width = 0.18
global persist $help_height = 0.045

; ==================== 按键控制 ====================

[KeySelectUp]
key = VK_UP
type = standard
run = CommandListSelectUp

[CommandListSelectUp]
if $selected_character > 0
    $selected_character = $selected_character - 1
else
    $selected_character = $max_characters - 1
endif

[KeySelectDown]
key = VK_DOWN
type = standard
run = CommandListSelectDown

[CommandListSelectDown]
if $selected_character < $max_characters - 1
    $selected_character = $selected_character + 1
else
    $selected_character = 0
endif

[KeyToggleUI]
key = VK_RETURN
type = standard
run = CommandToggleUI

[CommandToggleUI]
if $show_character_ui == 0
    $show_character_ui = 1
else
    $show_character_ui = 0
endif

; ==================== GUI渲染系统 ====================

[Present]
; 在Present阶段绘制UI（每帧执行一次）
if $show_character_ui == 1
    run = CustomShaderDrawUI
endif

[CustomShaderDrawUI]
; 设置渲染状态
vs = shaders\draw_2d_ui.hlsl
ps = shaders\draw_2d_ui.hlsl
run = BuiltInCommandListUnbindAllRenderTargets
blend = ADD SRC_ALPHA INV_SRC_ALPHA  ; 启用alpha混合
cull = none
topology = triangle_strip
o0 = set_viewport bb

; 1. 绘制背景面板
x87 = $ui_width
y87 = $ui_height
z87 = $ui_pos_x
w87 = $ui_pos_y
ps-t100 = ResourceUIBackground
Draw = 4,0

; 2. 绘制当前选中角色的图像
if $selected_character == 0
    ps-t100 = ResourceCharacter0Selected
    Draw = 4,0
else if $selected_character == 1
    ps-t100 = ResourceCharacter1Selected
    Draw = 4,0
else if $selected_character == 2
    ps-t100 = ResourceCharacter2Selected
    Draw = 4,0
else if $selected_character == 3
    ps-t100 = ResourceCharacter3Selected
    Draw = 4,0
endif

; 3. 绘制帮助文本（位置1）
x87 = $help_width
y87 = $help_height
z87 = $help_pos_x
w87 = $help_pos_y
ps-t100 = ResourceHelpText1
Draw = 4,0

; 4. 绘制帮助文本（位置2）
w87 = $help_pos_y + 0.05
ps-t100 = ResourceHelpText2
Draw = 4,0

; 5. 绘制帮助文本（位置3）
w87 = $help_pos_y + 0.10
ps-t100 = ResourceHelpText3
Draw = 4,0

; 清理纹理绑定
ps-t100 = null

; ==================== 纹理资源定义 ====================
; 这些资源引用由generate_ui_textures.py生成的图像文件
; 注意：需要将PNG转换为DDS格式才能在游戏中使用

; UI背景
[ResourceUIBackground]
filename = resources\textures\ui_background.png

; 角色选中状态图像（ID 0 - 莱万汀）
[ResourceCharacter0Normal]
filename = resources\textures\character_0_normal.png

[ResourceCharacter0Selected]
filename = resources\textures\character_0_selected.png

; 角色选中状态图像（ID 1 - 佩丽卡）
[ResourceCharacter1Normal]
filename = resources\textures\character_1_normal.png

[ResourceCharacter1Selected]
filename = resources\textures\character_1_selected.png

; 角色选中状态图像（ID 2 - 恩德敏）
[ResourceCharacter2Normal]
filename = resources\textures\character_2_normal.png

[ResourceCharacter2Selected]
filename = resources\textures\character_2_selected.png

; 角色选中状态图像（ID 3 - 卡塔琳娜）
[ResourceCharacter3Normal]
filename = resources\textures\character_3_normal.png

[ResourceCharacter3Selected]
filename = resources\textures\character_3_selected.png

; 帮助文本图像
[ResourceHelpText1]
filename = resources\textures\help_↑↓__切换角色.png

[ResourceHelpText2]
filename = resources\textures\help_数字键__控制功能.png

[ResourceHelpText3]
filename = resources\textures\help_Enter__显示_隐藏UI.png

; ==================== 使用说明 ====================
;
; 【部署步骤】
;
; 1. 生成UI纹理：
;    python generate_ui_textures.py
;    这将在resources/textures/目录生成PNG图像
;
; 2. 将整个mod文件夹复制到3DMigoto的Mods目录：
;    [游戏目录]/Mods/EFMI_KeyManager/
;      ├─ mod.ini (本文件)
;      ├─ shaders/
;      │   └─ draw_2d_ui.hlsl
;      └─ resources/
;          └─ textures/
;              ├─ character_0_selected.dds
;              ├─ character_1_selected.dds
;              └─ ...
;
; 4. 运行key_context_configurator.py配置其他mod的按键绑定
;
; 【游戏内操作】
;
; - ↑/↓键：切换选中的角色
; - Enter键：显示/隐藏UI
; - 数字键：控制当前选中角色的功能（由各mod定义）
;
; 【自定义UI】
;
; 修改Constants中的位置和大小变量：
; - $ui_pos_x, $ui_pos_y: UI位置（0-1范围）
; - $ui_width, $ui_height: UI大小（相对屏幕）
; - $help_pos_x, $help_pos_y: 帮助文本位置
;
; 【添加更多角色】
;
; 1. 修改generate_ui_textures.py中的角色名称列表
; 2. 重新生成纹理
; 3. 在本文件中添加对应的Resource定义和条件判断
; 4. 更新$max_characters变量
;
; ==================== 技术说明 ====================
;
; 【为什么不能直接显示文本？】
;
; 3DMigoto本身不提供文本渲染API，只能：
; - 绘制3D模型（需要顶点、索引缓冲区）
; - 绘制带纹理的2D四边形（本方案）
; - 修改游戏原有的渲染调用
;
; 【2D绘制原理】
;
; 1. 着色器使用SV_VertexID程序化生成四边形顶点
; 2. 无需顶点缓冲区，通过Draw = 4,0绘制4个顶点
; 3. topology = triangle_strip将4个顶点连接成2个三角形
; 4. IniParams[87]传递位置和大小参数到着色器
; 5. ps-t100绑定纹理资源，在像素着色器中采样显示
;
; 【参考资料】
;
; - Snaccubus的EndminF MegaMenu Mod（优秀的UI实现范例）
; - 3DMigoto官方文档：https://github.com/bo3b/3Dmigoto
; - HLSL着色器语法：https://docs.microsoft.com/en-us/windows/win32/direct3dhlsl/
;
; ==================== 故障排除 ====================
;
; 【UI不显示】
; - 检查DDS文件是否存在于正确路径
; - 检查3DMigoto日志（d3dx.log）是否有资源加载错误
; - 确认$show_character_ui = 1
; - 尝试按Enter键切换显示状态
;
; 【UI位置不对】
; - 调整$ui_pos_x和$ui_pos_y值（0-1范围）
; - 不同分辨率可能需要不同的位置设置
;
; 【图像模糊或失真】
; - 使用更高分辨率的源图像重新生成纹理
; - 尝试不同的DDS压缩格式（BC7_UNORM, BC3_UNORM等）
;
; 【角色切换不正常】
; - 检查$max_characters是否设置正确
; - 确保所有角色都有对应的纹理资源
;

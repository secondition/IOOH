; EFMI Key Context Manager
; 按键上下文切换系统 - 用有限按键控制多个角色
; 作者: EFMI Community
; 版本: 1.0

; ==================== 全局状态管理 ====================

[Constants]
global persist $active_character = 0
; 0 = 无激活角色
; 1-20 = 角色ID (可扩展到更多)
global $max_characters = 20
global $show_notification = 1
global persist $gui_visible = 0
global persist $selected_character_index = 0

; ==================== 角色激活按键 ====================
; 使用 Tab 键打开/关闭角色选择GUI
; 使用 上/下方向键 在GUI中切换角色
; 使用 Enter 确认选择
; 使用 ESC 关闭GUI并重置角色

[KeyToggleCharacterGUI]
key = VK_TAB
type = standard
run = CommandListToggleGUI

[CommandListToggleGUI]
if $gui_visible == 0
    $gui_visible = 1
else
    $gui_visible = 0
endif

[KeyPreviousCharacter]
key = VK_UP
type = standard
condition = $gui_visible == 1
run = CommandListPreviousCharacter

[CommandListPreviousCharacter]
if $selected_character_index > 0
    $selected_character_index = $selected_character_index - 1
else
    $selected_character_index = $max_characters - 1
endif
run = CommandListUpdateActiveCharacter

[KeyNextCharacter]
key = VK_DOWN
type = standard
condition = $gui_visible == 1
run = CommandListNextCharacter

[CommandListNextCharacter]
if $selected_character_index < $max_characters - 1
    $selected_character_index = $selected_character_index + 1
else
    $selected_character_index = 0
endif
run = CommandListUpdateActiveCharacter

[KeyConfirmSelection]
key = VK_RETURN
type = standard
condition = $gui_visible == 1
run = CommandListConfirmSelection

[CommandListConfirmSelection]
run = CommandListUpdateActiveCharacter
$gui_visible = 0
run = CommandListNotifyCharacterSwitch

[CommandListUpdateActiveCharacter]
; 根据 selected_character_index 更新 active_character
; 注意：index 从 0 开始，character ID 从 1 开始
$active_character = $selected_character_index + 1

[KeyResetContext]
key = VK_ESCAPE
type = standard
condition = $gui_visible == 1
$active_character = 0
$gui_visible = 0
run = CommandListNotifyContextReset

; ==================== 通知系统 ====================

[CommandListNotifyCharacterSwitch]
if $show_notification
    ; 显示OSD通知（如果EFMI支持）
    ; 可以在这里添加自定义通知逻辑
endif

[CommandListNotifyContextReset]
if $show_notification
    ; 显示"已重置上下文"通知
endif

; ==================== Present钩子 ====================

[Present]
; 在每一帧检查并维护状态
if $active_character > $max_characters
    $active_character = 0
endif

; ==================== 按键映射规范 ====================
; 
; 统一按键映射（建议其他mod遵循此规范）：
; 
; 小键盘区域：
;   NUMPAD1 (VK_NUMPAD1) - 衣服/上衣切换
;   NUMPAD2 (VK_NUMPAD2) - 裤子/下装切换  
;   NUMPAD3 (VK_NUMPAD3) - 鞋子切换
;   NUMPAD4 (VK_NUMPAD4) - 外套/夹克切换
;   NUMPAD5 (VK_NUMPAD5) - 装备/配件切换
;   NUMPAD6 (VK_NUMPAD6) - 袜子/丝袜切换
;   NUMPAD7 (VK_NUMPAD7) - 手套切换
;   NUMPAD8 (VK_NUMPAD8) - 头饰/帽子切换
;   NUMPAD9 (VK_NUMPAD9) - 特殊部位1
;   NUMPAD0 (VK_NUMPAD0) - 特殊部位2
;
; 方向键（备用）：
;   VK_UP    - 备用功能1
;   VK_DOWN  - 备用功能2
;   VK_LEFT  - 备用功能3
;   VK_RIGHT - 备用功能4
;
; ==================== 使用说明 ====================
;
; 1. 将此mod放入Mods文件夹
; 2. 使用配套的Python工具修改其他角色mod
; 3. 按Tab打开角色选择GUI
; 4. 使用↑/↓选择角色，按Enter激活
; 5. 激活后，小键盘按键只控制当前角色
;
; ==================== 角色ID分配表 ====================
;
; 请使用配套工具自动生成，或手动编辑：
; ID 1 = 佩丽卡 (Perlica)
; ID 2 = [待分配]
; ID 3 = [待分配]
; ...
;
; 在此文件末尾添加角色映射配置：

[ResourceCharacterMapping]
type = Buffer
; 角色ID映射表（由配置工具生成）
data = "Character ID Mapping:\n"

; ==================== 自动生成标记 ====================
; 以下内容由配置工具自动生成和更新
; 请勿手动修改

; EFMI Key Context Manager v1.0
; GitHub: https://github.com/SpectrumQT/EFMI-Tools
; Discord: https://discord.com/invite/agmf

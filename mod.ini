; EFMI Key Context Manager
; 按键上下文切换系统 - 游戏内GUI选择角色，用统一的小键盘按键控制不同角色的模型切换
; 功能: 
;   - 游戏内可视化GUI（按Tab显示）
;   - 自动检测mod的cycle按键，统一映射到小键盘0-9及运算符按键
;   - 通过imgui overlay显示角色列表和当前选择
; 作者: EFMI Community
; 版本: 2.0

; ==================== 全局状态管理 ====================

[Constants]
global persist $active_character = 0
; 0 = 无激活角色
; 1-20 = 角色ID (可扩展到更多)
global $max_characters = 2
global $show_notification = 1
global persist $gui_visible = 0
global persist $selected_character_index = 0

; GUI显示参数
global $gui_width_x = 0.4
global $gui_width_y = 0.6
global $gui_loc_x = 0.3
global $gui_loc_y = 0.2

; 角色列表项参数
global $item_width_x = 0.35
global $item_width_y = 0.08
global $item_loc_x = 0.325
global $item_start_y = 0.3
global $item_spacing = 0.09

; ==================== 角色激活按键 ====================
; 使用 Tab 键打开/关闭角色选择GUI
; 使用 上/下方向键 在GUI中切换角色
; 使用 Enter 确认选择
; 使用 ESC 关闭GUI并重置角色

[KeyToggleCharacterGUI]
key = VK_TAB
type = standard
run = CommandListToggleGUI

[CommandListToggleGUI]
if $gui_visible == 0
    $gui_visible = 1
    ; 打印当前角色列表到log（可按F10查看3DMigoto控制台）
    run = CommandListPrintCharacterList
else
    $gui_visible = 0
endif

[KeyPreviousCharacter]
key = VK_UP
type = standard
condition = $gui_visible == 1
run = CommandListPreviousCharacter

[CommandListPreviousCharacter]
if $selected_character_index > 0
    $selected_character_index = $selected_character_index - 1
else
    $selected_character_index = $max_characters - 1
endif
run = CommandListUpdateActiveCharacter

[KeyNextCharacter]
key = VK_DOWN
type = standard
condition = $gui_visible == 1
run = CommandListNextCharacter

[CommandListNextCharacter]
if $selected_character_index < $max_characters - 1
    $selected_character_index = $selected_character_index + 1
else
    $selected_character_index = 0
endif
run = CommandListUpdateActiveCharacter

[KeyConfirmSelection]
key = VK_RETURN
type = standard
condition = $gui_visible == 1
run = CommandListConfirmSelection

[CommandListConfirmSelection]
run = CommandListUpdateActiveCharacter
$gui_visible = 0
run = CommandListNotifyCharacterSwitch

[CommandListUpdateActiveCharacter]
; 根据 selected_character_index 更新 active_character
; 注意：index 从 0 开始，character ID 从 1 开始
$active_character = $selected_character_index + 1

[KeyResetContext]
key = VK_ESCAPE
type = standard
condition = $gui_visible == 1
$active_character = 0
$gui_visible = 0
run = CommandListNotifyContextReset

; ==================== 通知系统 ====================

[CommandListNotifyCharacterSwitch]
if $show_notification
    ; 显示OSD通知（如果EFMI支持）
    ; 可以在这里添加自定义通知逻辑
endif

[CommandListNotifyContextReset]
if $show_notification
    ; 显示"已重置上下文"通知
endif

[CommandListPrintCharacterList]
; 这个命令在打开GUI时被调用
; 可以在这里添加日志输出（需要3DMigoto支持）

; ==================== Present钩子 ====================

[Present]
; 在每一帧检查并维护状态
if $active_character > $max_characters
    $active_character = 0
endif

; 绘制GUI（当可见时）
if $gui_visible == 1
    run = CustomShaderDrawGUI
endif

; ==================== GUI绘制系统 ====================

[CustomShaderDrawGUI]
; 只在shader文件存在时绘制GUI
vs = shaders\draw_2d.hlsl
ps = shaders\draw_2d.hlsl
run = BuiltInCommandListUnbindAllRenderTargets
blend = ADD SRC_ALPHA INV_SRC_ALPHA
cull = none
topology = triangle_strip
o0 = set_viewport bb

; 绘制背景面板
x87 = $gui_width_x
y87 = $gui_width_y
z87 = $gui_loc_x
w87 = $gui_loc_y
ps-t100 = ResourceGUIBackground
Draw = 4,0

; 绘制标题
x87 = $gui_width_x
y87 = 0.08
z87 = $gui_loc_x
w87 = $gui_loc_y + 0.02
ps-t100 = ResourceGUITitle
Draw = 4,0

; 绘制角色列表项（根据配置工具生成）
; === 以下由配置工具自动生成 ===
; === 以下由配置工具自动生成 ===
; === 以下由配置工具自动生成 ===
; === 以下由配置工具自动生成 ===
; [GUI_DRAW_START]
; 绘制角色 1: laevatain_mk3l_7fa3f
if $max_characters >= 1
    x87 = $item_width_x
    y87 = $item_width_y
    z87 = $item_loc_x
    w87 = $item_start_y + 0*$item_spacing
    if $selected_character_index == 0
        ps-t100 = ResourceCharacter1Selected
    else
        ps-t100 = ResourceCharacter1
    endif
    Draw = 4,0
endif

; 绘制角色 2: 佩丽卡
if $max_characters >= 2
    x87 = $item_width_x
    y87 = $item_width_y
    z87 = $item_loc_x
    w87 = $item_start_y + 1*$item_spacing
    if $selected_character_index == 1
        ps-t100 = ResourceCharacter2Selected
    else
        ps-t100 = ResourceCharacter2
    endif
    Draw = 4,0
endif

; [GUI_DRAW_END]

ps-t100 = null

; ==================== GUI资源定义 ====================
; 以下资源由配置工具自动生成

[ResourceGUIBackground]
filename = resources\gui_background.png

[ResourceGUITitle]
filename = resources\gui_title.png

; === 角色资源（由配置工具自动生成）===
; === 角色资源（由配置工具自动生成）===
; === 角色资源（由配置工具自动生成）===
; === 角色资源（由配置工具自动生成）===
; [GUI_RESOURCES_START]

[ResourceCharacter1]
filename = resources\character_1.png

[ResourceCharacter1Selected]
filename = resources\character_1_selected.png

[ResourceCharacter2]
filename = resources\character_2.png

[ResourceCharacter2Selected]
filename = resources\character_2_selected.png
; [GUI_RESOURCES_END]

; ==================== 按键映射规范 ====================
; 
; 自动按键映射规则（由配置工具自动分配）：
; 
; 按检测顺序自动分配到以下15个小键盘按键：
;   第1个检测到的按键  -> NUMPAD0 (VK_NUMPAD0)
;   第2个检测到的按键  -> NUMPAD1 (VK_NUMPAD1)
;   第3个检测到的按键  -> NUMPAD2 (VK_NUMPAD2)
;   第4个检测到的按键  -> NUMPAD3 (VK_NUMPAD3)
;   第5个检测到的按键  -> NUMPAD4 (VK_NUMPAD4)
;   第6个检测到的按键  -> NUMPAD5 (VK_NUMPAD5)
;   第7个检测到的按键  -> NUMPAD6 (VK_NUMPAD6)
;   第8个检测到的按键  -> NUMPAD7 (VK_NUMPAD7)
;   第9个检测到的按键  -> NUMPAD8 (VK_NUMPAD8)
;   第10个检测到的按键 -> NUMPAD9 (VK_NUMPAD9)
;   第11个检测到的按键 -> + (VK_ADD)
;   第12个检测到的按键 -> - (VK_SUBTRACT)
;   第13个检测到的按键 -> * (VK_MULTIPLY)
;   第14个检测到的按键 -> / (VK_DIVIDE)
;   第15个检测到的按键 -> . (VK_DECIMAL)
;
; 注意：工具只处理 type=cycle 的按键（模型切换功能）
;      超过15个按键的mod会保持原始按键配置并给出警告
;
; ==================== 使用说明 ====================
;
; 1. 将此mod放入Mods文件夹
; 2. 运行配套的Python配置工具 (key_context_configurator.py)
;    - 扫描mods目录，自动检测所有mod的.ini文件
;    - 自动识别 type=cycle 的按键（模型切换功能）
;    - 按检测顺序自动分配小键盘按键（0-9, +, -, *, /, .）
;    - 为每个按键添加 $active_character 条件
;    - 自动备份原始.ini文件
; 3. 游戏内使用：
;    - 按Tab打开角色选择GUI
;    - 使用↑/↓选择角色，按Enter激活
;    - 激活后，小键盘按键只控制当前激活的角色
;
; ==================== 角色ID分配表 ====================
;
; 请使用配套工具自动生成，或手动编辑：
; ID 1 = 佩丽卡 (Perlica)
; ID 2 = [待分配]
; ID 3 = [待分配]
; ...
;
; 在此文件末尾添加角色映射配置：

[ResourceCharacterMapping]
type = Buffer
; 角色ID映射表（由配置工具生成）
data = "Character ID Mapping:\n"

; ==================== 自动生成标记 ====================
; 以下内容由配置工具自动生成和更新
; 请勿手动修改

; EFMI Key Context Manager v1.0
; GitHub: https://github.com/SpectrumQT/EFMI-Tools
; Discord: https://discord.com/invite/agmf
